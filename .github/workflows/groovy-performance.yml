# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Performance Benchmarks

# Run on demand, scheduled weekly, or on performance-related PRs
on:
  workflow_dispatch:
    inputs:
      benchmark_filter:
        description: 'Filter by benchmark class name (e.g., CallsiteBench, PropertyAccess). Leave empty for all.'
        required: false
        default: ''
      compare_baseline:
        description: 'Compare against baseline'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # Run every Sunday at 2am UTC
    - cron: '0 2 * * 0'
  pull_request:
    paths:
      - 'src/main/**/runtime/**'
      - 'src/main/**/vmplugin/**'
      - 'subprojects/performance/**'
  push:
    paths:
      - 'src/main/**/runtime/**'
      - 'src/main/**/vmplugin/**'
      - 'subprojects/performance/**'

permissions:
  contents: read

env:
  DEVELOCITY_ACCESS_KEY: ${{ secrets.DEVELOCITY_ACCESS_KEY }}

  # ============================================================================
  # Full benchmark suite: build once, fan out into parallel matrix jobs
  # ============================================================================
jobs:
  # Step 1: Build the JMH fat jar and discover benchmark groups
  build-jmh-jar:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      - uses: gradle/actions/setup-gradle@v4

      - name: Build JMH fat jar and discover groups
        run: ./gradlew :performance:jmhGroups

      - name: Build matrix from groups
        id: set-matrix
        run: |
          JMH_GROUPS=subprojects/performance/build/jmh-groups.json
          FILTER="${{ github.event.inputs.benchmark_filter }}"
          if [ -n "$FILTER" ]; then
            MATRIX=$(jq -c --arg f "$FILTER" '{include: [.[] | select(.group | contains($f)) | {group, pattern, indy: true}, {group, pattern, indy: false}]}' "$JMH_GROUPS")
          else
            MATRIX=$(jq -c '{include: [.[] | {group, pattern, indy: true}, {group, pattern, indy: false}]}' "$JMH_GROUPS")
          fi
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

      - name: Upload JMH jar
        uses: actions/upload-artifact@v4
        with:
          name: jmh-jar
          path: subprojects/performance/build/libs/*-jmh.jar
          retention-days: 1

  # Step 2: Run benchmarks in parallel (groups x indy modes)
  benchmark-matrix:
    needs: build-jmh-jar
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.build-jmh-jar.outputs.matrix) }}
    steps:
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Download JMH jar
        uses: actions/download-artifact@v4
        with:
          name: jmh-jar
          path: .

      - name: Run benchmarks (${{ matrix.group }}, indy=${{ matrix.indy }})
        run: |
          JAR=$(ls *-jmh.jar | head -1)
          java \
            -Dgroovy.target.indy=${{ matrix.indy }} \
            -jar "$JAR" \
            "${{ matrix.pattern }}" \
            -f 3 -wi 3 -i 5 \
            -rf json -rff results.json
        timeout-minutes: 110

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bench-${{ matrix.group }}-indy-${{ matrix.indy }}
          path: results.json
          retention-days: 5
